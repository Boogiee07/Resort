<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Logs</title>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            margin-bottom: 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-title {
            font-size: 32px;
            font-weight: 700;
            color: #111827;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            background: #2563eb;
        }

        .btn-success {
            background: #22c55e;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #16a34a;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .filter-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid #f1f5f9;
            margin-bottom: 24px;
        }

        .filter-title {
            font-size: 18px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 20px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .logs-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid #f1f5f9;
            overflow: hidden;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            text-align: left;
            padding: 16px 20px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 16px 20px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
            color: #374151;
        }

        tbody tr:hover {
            background: #f8fafc;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .timestamp {
            color: #64748b;
            font-weight: 600;
            white-space: nowrap;
        }

        .admin-user {
            font-weight: 600;
            color: #111827;
        }

        .action-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .action-login { background: #dbeafe; color: #1e40af; }
        .action-logout { background: #d1d5db; color: #374151; }
        .action-archive { background: #cffafe; color: #0e7490; }
        .action-restore { background: #d1fae5; color: #065f46; }
        .action-delete { background: #fee2e2; color: #991b1b; }
        .action-create { background: #e9d5ff; color: #6b21a8; }
        .action-update { background: #fef3c7; color: #92400e; }

        .target {
            font-weight: 500;
            color: #1f2937;
        }

        .details {
            color: #374151;
            max-width: 400px;
        }

        .empty-state {
            padding: 64px 48px;
            text-align: center;
        }

        .empty-icon {
            width: 64px;
            height: 64px;
            color: #cbd5e1;
            margin: 0 auto 16px;
        }

        .empty-title {
            font-size: 20px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 8px;
        }

        .empty-text {
            color: #64748b;
            font-size: 14px;
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 32px;
            border-radius: 12px;
            text-align: center;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid #e2e8f0;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: #64748b;
            font-size: 14px;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-top: 1px solid #f1f5f9;
        }

        .pagination-info {
            font-size: 14px;
            color: #64748b;
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
        }

        .pagination-btn {
            padding: 8px 16px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #f8fafc;
            border-color: #3b82f6;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 12px 16px;
            }

            .details {
                max-width: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="loading-text">Generating PDF...</p>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <i data-lucide="file-text" style="width: 36px; height: 36px; color: #667eea;"></i>
                <h1 class="header-title">Activity Logs</h1>
            </div>
            <div class="header-actions">
                <a href="index.html" class="btn btn-primary">
                    <i data-lucide="home" style="width: 18px; height: 18px;"></i>
                    Home
                </a>
                <button id="signout-btn" class="btn btn-danger">
                    <i data-lucide="log-out" style="width: 18px; height: 18px;"></i>
                    Sign Out
                </button>
            </div>
        </div>

        <!-- Filter Card -->
        <div class="filter-card">
            <h2 class="filter-title">Generate PDF Report</h2>
            <div class="filter-grid">
                <div class="form-group">
                    <label class="form-label">Start Date</label>
                    <input type="date" id="start-date" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">End Date</label>
                    <input type="date" id="end-date" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Resorts Filter</label>
                    <select id="resort-filter">
                        <option value="all">All Resorts</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button id="download-selected" class="btn btn-primary">
                    <i data-lucide="download" style="width: 18px; height: 18px;"></i>
                    Download Selected Logs
                </button>
                <button id="download-all" class="btn btn-success">
                    <i data-lucide="download" style="width: 18px; height: 18px;"></i>
                    Download All Logs
                </button>
            </div>
        </div>

        <!-- Activity Logs Table -->
        <div class="logs-card">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>TIMESTAMP</th>
                            <th>ADMIN USER</th>
                            <th>ACTION TYPE</th>
                            <th>TARGET</th>
                            <th>DETAILS</th>
                        </tr>
                    </thead>
                    <tbody id="logs-tbody">
                        <tr>
                            <td colspan="5">
                                <div class="empty-state">
                                    <i data-lucide="inbox" class="empty-icon"></i>
                                    <h3 class="empty-title">No activity logs found</h3>
                                    <p class="empty-text">Activity logs will appear here as actions are performed.</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination" id="pagination">
                <div class="pagination-info" id="pagination-info">Showing 0 of 0 logs</div>
                <div class="pagination-controls">
                    <button class="pagination-btn" id="prev-page" disabled>Previous</button>
                    <button class="pagination-btn" id="next-page" disabled>Next</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDoILyFqD0iuOe4DfA2YoyjNiu30Mzw_DM",
            authDomain: "resort-ec9b6.firebaseapp.com",
            databaseURL: "https://resort-ec9b6-default-rtdb.firebaseio.com",
            projectId: "resort-ec9b6",
            storageBucket: "resort-ec9b6.firebasestorage.app",
            messagingSenderId: "1034701877647",
            appId: "1:1034701877647:web:e14e3e791b9d7780e15bfa",
            measurementId: "G-12YD26J2E8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let allLogs = [];
        let resorts = new Set();
        let currentPage = 1;
        const logsPerPage = 50;

        // Check authentication
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'dashboard.html';
            } else {
                loadActivityLogs();
            }
        });

        // Load activity logs
        function loadActivityLogs() {
            const logsRef = collection(db, 'activityLogs');
            const logsQuery = query(logsRef, orderBy('timestamp', 'desc'));

            onSnapshot(logsQuery, (snapshot) => {
                allLogs = [];
                resorts.clear();

                snapshot.forEach((doc) => {
                    const log = { id: doc.id, ...doc.data() };
                    allLogs.push(log);

                    if (log.target && log.target.includes('-')) {
                        const resortName = log.target.split('-')[0];
                        resorts.add(resortName);
                    }
                });

                updateResortFilter();
                renderLogs();
            });
        }

        // Update resort filter dropdown
        function updateResortFilter() {
            const resortFilter = document.getElementById('resort-filter');
            const currentValue = resortFilter.value;
            
            const sortedResorts = Array.from(resorts).sort();
            resortFilter.innerHTML = '<option value="all">All Resorts</option>' +
                sortedResorts.map(resort => `<option value="${resort}">${resort}</option>`).join('');
            
            if (sortedResorts.includes(currentValue)) {
                resortFilter.value = currentValue;
            }
        }

        // Render logs
        function renderLogs() {
            const tbody = document.getElementById('logs-tbody');
            const startIndex = (currentPage - 1) * logsPerPage;
            const endIndex = startIndex + logsPerPage;
            const logsToShow = allLogs.slice(startIndex, endIndex);

            if (logsToShow.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5">
                            <div class="empty-state">
                                <i data-lucide="inbox" class="empty-icon"></i>
                                <h3 class="empty-title">No activity logs found</h3>
                                <p class="empty-text">Activity logs will appear here as actions are performed.</p>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = logsToShow.map(log => {
                    const timestamp = log.timestamp?.toDate ? log.timestamp.toDate() : new Date(log.timestamp);
                    const actionClass = `action-${(log.actionType || '').toLowerCase().replace('_', '-')}`;
                    
                    return `
                        <tr>
                            <td class="timestamp">${timestamp.toLocaleString('en-US', { 
                                month: 'short', 
                                day: 'numeric', 
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: true
                            })}</td>
                            <td class="admin-user">${escapeHtml(log.adminUser || 'Unknown')}</td>
                            <td><span class="action-badge ${actionClass}">${escapeHtml(log.actionType || 'UNKNOWN')}</span></td>
                            <td class="target">${escapeHtml(log.target || 'N/A')}</td>
                            <td class="details">${escapeHtml(log.details || 'No details')}</td>
                        </tr>
                    `;
                }).join('');
            }

            // Update pagination
            updatePagination();
            lucide.createIcons();
        }

        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(allLogs.length / logsPerPage);
            const startIndex = (currentPage - 1) * logsPerPage + 1;
            const endIndex = Math.min(currentPage * logsPerPage, allLogs.length);

            document.getElementById('pagination-info').textContent = 
                `Showing ${startIndex}-${endIndex} of ${allLogs.length} logs`;
            
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages || totalPages === 0;
        }

        // Pagination controls
        document.getElementById('prev-page').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderLogs();
            }
        });

        document.getElementById('next-page').addEventListener('click', () => {
            const totalPages = Math.ceil(allLogs.length / logsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderLogs();
            }
        });

        // Filter logs based on criteria
        function getFilteredLogs() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const resortFilter = document.getElementById('resort-filter').value;

            return allLogs.filter(log => {
                const logDate = log.timestamp?.toDate ? log.timestamp.toDate() : new Date(log.timestamp);
                const logDateStr = logDate.toISOString().split('T')[0];

                const matchesStartDate = !startDate || logDateStr >= startDate;
                const matchesEndDate = !endDate || logDateStr <= endDate;
                const matchesResort = resortFilter === 'all' || 
                    (log.target && log.target.startsWith(resortFilter));

                return matchesStartDate && matchesEndDate && matchesResort;
            });
        }

        // Generate PDF
        async function generatePDF(logs, filename) {
            document.getElementById('loading').classList.add('active');

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4');

                // Title
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text('Activity Logs Report', 14, 20);

                // Filters info
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                const startDate = document.getElementById('start-date').value || 'All';
                const endDate = document.getElementById('end-date').value || 'All';
                const resort = document.getElementById('resort-filter').value;
                
                doc.text(`Start Date: ${startDate}`, 14, 30);
                doc.text(`End Date: ${endDate}`, 14, 35);
                doc.text(`Resort: ${resort === 'all' ? 'All Resorts' : resort}`, 14, 40);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 45);
                doc.text(`Total Logs: ${logs.length}`, 14, 50);

                // Table
                const tableData = logs.map(log => {
                    const timestamp = log.timestamp?.toDate ? log.timestamp.toDate() : new Date(log.timestamp);
                    return [
                        timestamp.toLocaleString('en-US', { 
                            month: 'short', 
                            day: 'numeric', 
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        }),
                        log.adminUser || 'Unknown',
                        log.actionType || 'UNKNOWN',
                        log.target || 'N/A',
                        log.details || 'No details'
                    ];
                });

                doc.autoTable({
                    startY: 55,
                    head: [['TIMESTAMP', 'ADMIN USER', 'ACTION TYPE', 'TARGET', 'DETAILS']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: {
                        fillColor: [102, 126, 234],
                        textColor: 255,
                        fontStyle: 'bold',
                        fontSize: 9
                    },
                    bodyStyles: {
                        fontSize: 8
                    },
                    columnStyles: {
                        0: { cellWidth: 40 },
                        1: { cellWidth: 50 },
                        2: { cellWidth: 35 },
                        3: { cellWidth: 55 },
                        4: { cellWidth: 'auto' }
                    }
                });

                doc.save(filename);
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Failed to generate PDF. Please try again.');
            } finally {
                document.getElementById('loading').classList.remove('active');
            }
        }

        // Download selected logs
        document.getElementById('download-selected').addEventListener('click', () => {
            const filteredLogs = getFilteredLogs();
            
            if (filteredLogs.length === 0) {
                alert('No logs match the selected filters.');
                return;
            }

            const startDate = document.getElementById('start-date').value || 'all';
            const endDate = document.getElementById('end-date').value || 'all';
            const resort = document.getElementById('resort-filter').value;
            const filename = `activity-logs-${startDate}-to-${endDate}-${resort}.pdf`;
            
            generatePDF(filteredLogs, filename);
        });

        // Download all logs
        document.getElementById('download-all').addEventListener('click', () => {
            if (allLogs.length === 0) {
                alert('No logs available to download.');
                return;
            }

            const filename = `activity-logs-all-${new Date().toISOString().split('T')[0]}.pdf`;
            generatePDF(allLogs, filename);
        });

        // Sign out
        document.getElementById('signout-btn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Sign out error:', error);
                alert('Failed to sign out. Please try again.');
            }
        });

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize icons
        lucide.createIcons();
    </script>
</body>
</html>
