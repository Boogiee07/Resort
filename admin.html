<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Pansol Resorts</title>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Loading State */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loading-content {
      text-align: center;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 3px solid #e2e8f0;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loading-text {
      color: #64748b;
      font-size: 14px;
    }

    /* Login Container */
    .login-wrapper {
      display: none;
      min-height: 100vh;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .login-box {
      width: 100%;
      max-width: 420px;
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #3b82f6;
      font-size: 14px;
      font-weight: 600;
      text-decoration: none;
      margin-bottom: 24px;
      padding: 8px 12px;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .back-link:hover {
      background: #eff6ff;
      color: #2563eb;
    }

    .login-title {
      font-size: 28px;
      font-weight: 700;
      color: #111827;
      text-align: center;
      margin-bottom: 32px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 8px;
    }

    .form-input, .form-textarea, .form-select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
      font-family: inherit;
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .error-message {
      min-height: 20px;
      font-size: 13px;
      color: #dc2626;
      margin-bottom: 16px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }

    .btn-primary {
      width: 100%;
      background: #3b82f6;
      color: white;
      box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:hover:not(:disabled) {
      background: #2563eb;
    }

    .btn-success {
      background: #22c55e;
      color: white;
    }

    .btn-success:hover:not(:disabled) {
      background: #16a34a;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover:not(:disabled) {
      background: #dc2626;
    }

    .btn-secondary {
      background: #64748b;
      color: white;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #475569;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Main Content */
    .main-content {
      display: none;
    }

    .header {
      margin-bottom: 32px;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      flex-wrap: wrap;
      gap: 16px;
    }

    .header-title {
      font-size: 32px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 8px;
    }

    .header-subtitle {
      color: #64748b;
      font-size: 14px;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .user-id {
      font-size: 11px;
      color: #3b82f6;
      font-family: 'Courier New', monospace;
      margin-bottom: 24px;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
      border: 1px solid #f1f5f9;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .stat-info {
      flex: 1;
    }

    .stat-label {
      font-size: 13px;
      color: #64748b;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #111827;
    }

    .stat-icon {
      width: 48px;
      height: 48px;
    }

    .icon-blue {
      color: #3b82f6;
    }

    .icon-green {
      color: #22c55e;
    }

    .icon-yellow {
      color: #eab308;
    }

    .icon-red {
      color: #ef4444;
    }

    .icon-orange {
      color: #f97316;
    }

    .icon-purple {
      color: #a855f7;
    }

    /* Tab Navigation */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      background: white;
      padding: 8px;
      border-radius: 12px;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
      border: 1px solid #f1f5f9;
      overflow-x: auto;
    }

    .tab-btn {
      flex: 1;
      padding: 12px 24px;
      background: transparent;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: #64748b;
      white-space: nowrap;
    }

    .tab-btn:hover {
      background: #f8fafc;
    }

    .tab-btn.active {
      background: #3b82f6;
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Resort Management Styles */
    .resort-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
      border: 1px solid #f1f5f9;
      overflow: hidden;
      margin-bottom: 16px;
    }

    .resort-header {
      display: flex;
      gap: 16px;
      padding: 20px;
      border-bottom: 1px solid #f1f5f9;
    }

    .resort-image {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
    }

    .resort-info {
      flex: 1;
    }

    .resort-name {
      font-size: 20px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 8px;
    }

    .resort-address {
      font-size: 14px;
      color: #64748b;
      margin-bottom: 12px;
    }

    .resort-badges {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .badge {
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-budget {
      background: #dcfce7;
      color: #166534;
    }

    .badge-mid {
      background: #dbeafe;
      color: #1e40af;
    }

    .badge-premium {
      background: #f3e8ff;
      color: #6b21a8;
    }

    .resort-actions {
      display: flex;
      gap: 8px;
      align-items: flex-start;
    }

    .resort-body {
      padding: 20px;
    }

    .resort-description {
      color: #374151;
      line-height: 1.6;
      margin-bottom: 16px;
    }

    .resort-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .detail-item {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #64748b;
      font-size: 14px;
    }

    /* Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 24px;
      overflow-y: auto;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 16px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease-out;
      display: flex;
      flex-direction: column;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .modal-header-info {
      flex: 1;
    }

    .modal-title {
      font-size: 24px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 8px;
    }

    .modal-subtitle {
      font-size: 14px;
      color: #64748b;
    }

    .modal-close {
      background: transparent;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      padding: 4px;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: #f3f4f6;
      color: #6b7280;
    }

    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 8px;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: background 0.2s;
    }

    .checkbox-label:hover {
      background: #f8fafc;
    }

    .checkbox-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .empty-state {
      background: white;
      padding: 64px 48px;
      border-radius: 12px;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
      border: 1px solid #f1f5f9;
      text-align: center;
    }

    .empty-icon {
      width: 64px;
      height: 64px;
      color: #cbd5e1;
      margin: 0 auto 16px;
    }

    .empty-title {
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }

    .empty-text {
      color: #64748b;
      font-size: 14px;
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .resort-header {
        flex-direction: column;
      }

      .resort-image {
        width: 100%;
        height: 200px;
      }

      .tabs {
        flex-direction: column;
      }

      .modal {
        max-width: 100%;
        margin: 0;
      }
    }

    .success-message {
      background: #dcfce7;
      color: #166534;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
  </style>
</head>

<body>
  <!-- Loading State -->
  <div id="loading" class="loading-overlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <p class="loading-text">Initializing...</p>
    </div>
  </div>

  <!-- Login Container -->
  <div id="login-container" class="login-wrapper">
    <div class="login-box">
      <a href="index.html" class="back-link">
        <i data-lucide="arrow-left" style="width: 20px; height: 20px;"></i>
        <span>Back to Home</span>
      </a>
      <h2 class="login-title">Admin Login</h2>
      <form id="login-form">
        <div class="form-group">
          <label class="form-label" for="login-email">Email Address</label>
          <input type="email" id="login-email" class="form-input" placeholder="admin@example.com" required
            autocomplete="email">
        </div>
        <div class="form-group">
          <label class="form-label" for="login-password">Password</label>
          <input type="password" id="login-password" class="form-input" placeholder="••••••••" required
            autocomplete="current-password">
        </div>
        <div class="error-message" id="login-error"></div>
        <button type="submit" class="btn btn-primary" id="login-btn">Sign In</button>
      </form>
    </div>
  </div>

  <!-- Main Content -->
  <div id="main-content" class="main-content">
    <div class="container">
      <!-- Header -->
      <div class="header">
        <div>
          <h1 class="header-title">Admin Dashboard</h1>
          <p class="header-subtitle">Manage resorts and feedback</p>
        </div>
        <div class="header-actions">
          <a href="index.html" class="btn btn-primary">
            <i data-lucide="home" style="width: 18px; height: 18px;"></i>
            Home
          </a>
          <button id="signout-btn" class="btn btn-danger">
            <i data-lucide="log-out" style="width: 18px; height: 18px;"></i>
            Sign Out
          </button>
        </div>
      </div>

      <p class="user-id" id="user-id-display"></p>

      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-info">
            <p class="stat-label">Total Resorts</p>
            <p class="stat-value" id="total-resorts">0</p>
          </div>
          <i data-lucide="building" class="stat-icon icon-purple"></i>
        </div>

        <div class="stat-card">
          <div class="stat-info">
            <p class="stat-label">Total Feedback</p>
            <p class="stat-value" id="total-feedback">0</p>
          </div>
          <i data-lucide="message-square" class="stat-icon icon-blue"></i>
        </div>

        <div class="stat-card">
          <div class="stat-info">
            <p class="stat-label">Average Rating</p>
            <p class="stat-value" id="avg-rating">0.0</p>
          </div>
          <i data-lucide="trending-up" class="stat-icon icon-green"></i>
        </div>

        <div class="stat-card">
          <div class="stat-info">
            <p class="stat-label">Archived</p>
            <p class="stat-value" id="archived-count">0</p>
          </div>
          <i data-lucide="archive" class="stat-icon icon-orange"></i>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" data-tab="resorts">
          <i data-lucide="building" style="width: 18px; height: 18px;"></i>
          Manage Resorts
        </button>
        <button class="tab-btn" data-tab="feedback">
          <i data-lucide="message-square" style="width: 18px; height: 18px;"></i>
          Feedback
        </button>
      </div>

      <!-- Resorts Tab -->
      <div class="tab-content active" id="tab-resorts">
        <div style="margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="font-size: 24px; font-weight: 700;">Resort List</h2>
          <button class="btn btn-success" id="add-resort-btn">
            <i data-lucide="plus" style="width: 18px; height: 18px;"></i>
            Add New Resort
          </button>
        </div>

        <div id="resorts-container"></div>
      </div>

      <!-- Feedback Tab -->
      <div class="tab-content" id="tab-feedback">
        <div style="margin-bottom: 24px;">
          <h2 style="font-size: 24px; font-weight: 700;">Customer Feedback</h2>
          <p style="color: #64748b; margin-top: 8px;">View and manage customer reviews</p>
        </div>
        <div id="feedback-container"></div>
      </div>
    </div>
  </div>

  <!-- Resort Modal -->
  <div class="modal-overlay" id="resort-modal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-header-info">
          <h2 class="modal-title" id="resort-modal-title">Add New Resort</h2>
          <p class="modal-subtitle">Fill in the resort details</p>
        </div>
        <button class="modal-close" id="resort-modal-close">
          <i data-lucide="x" style="width: 24px; height: 24px;"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="resort-form">
          <div class="form-group">
            <label class="form-label">Resort Name *</label>
            <input type="text" id="resort-name" class="form-input" required>
          </div>

          <div class="form-group">
            <label class="form-label">Address *</label>
            <input type="text" id="resort-address" class="form-input" required>
          </div>

          <div class="form-group">
            <label class="form-label">Description *</label>
            <textarea id="resort-description" class="form-textarea" required></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Image URL *</label>
              <input type="url" id="resort-image" class="form-input" required>
            </div>

            <div class="form-group">
              <label class="form-label">Number of Bedrooms *</label>
              <input type="number" id="resort-bedrooms" class="form-input" min="1" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Price Category *</label>
              <select id="resort-price" class="form-select" required>
                <option value="">Select category</option>
                <option value="budget">Budget</option>
                <option value="mid">Mid-Range</option>
                <option value="premium">Premium</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Price Value *</label>
              <input type="text" id="resort-price-value" class="form-input" placeholder="₱3,500 - ₱6,000" required>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Price (Numeric - for sorting) *</label>
            <input type="number" id="resort-price-numeric" class="form-input" min="0" required>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Latitude</label>
              <input type="number" id="resort-latitude" class="form-input" step="0.000001">
            </div>

            <div class="form-group">
              <label class="form-label">Longitude</label>
              <input type="number" id="resort-longitude" class="form-input" step="0.000001">
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Facilities (comma-separated) *</label>
            <textarea id="resort-facilities" class="form-textarea" placeholder="Swimming pools, Hot spring baths, Cottages"></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Amenities</label>
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" name="amenity" value="hot-spring">
                <span>Hot Spring</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="amenity" value="aircon">
                <span>Air Conditioning</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="amenity" value="kitchen">
                <span>Kitchen</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="amenity" value="karaoke">
                <span>Karaoke/Videoke</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="amenity" value="wifi">
                <span>WiFi</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="amenity" value="parking">
                <span>Parking</span>
              </label>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="resort-cancel-btn">Cancel</button>
        <button class="btn btn-success" id="resort-save-btn">Save Resort</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, setPersistence, browserLocalPersistence, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getDatabase, ref, onValue, push, set, update, remove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDoILyFqD0iuOe4DfA2YoyjNiu30Mzw_DM",
      authDomain: "resort-ec9b6.firebaseapp.com",
      databaseURL: "https://resort-ec9b6-default-rtdb.firebaseio.com",
      projectId: "resort-ec9b6",
      storageBucket: "resort-ec9b6.firebasestorage.app",
      messagingSenderId: "1034701877647",
      appId: "1:1034701877647:web:e14e3e791b9d7780e15bfa",
      measurementId: "G-12YD26J2E8"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const firestore = getFirestore(app);
    const auth = getAuth(app);

    let resorts = [];
    let feedbacks = [];
    let currentEditingResortKey = null;

    // Load Resorts
    function loadResorts() {
      const resortsRef = ref(db, 'resorts');
      onValue(resortsRef, (snapshot) => {
        resorts = [];
        snapshot.forEach((childSnapshot) => {
          resorts.push({
            key: childSnapshot.key,
            ...childSnapshot.val()
          });
        });
        renderResorts();
        updateStats();
      });
    }

    // Load Feedback
    function loadFeedback() {
      const feedbacksRef = collection(firestore, 'feedback');
      onSnapshot(feedbacksRef, (snapshot) => {
        feedbacks = [];
        snapshot.forEach((doc) => {
          feedbacks.push({ id: doc.id, ...doc.data() });
        });
        renderFeedback();
        updateStats();
      });
    }

    // Render Resorts
    function renderResorts() {
      const container = document.getElementById('resorts-container');
      
      if (resorts.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i data-lucide="building" class="empty-icon"></i>
            <h3 class="empty-title">No resorts yet</h3>
            <p class="empty-text">Click "Add New Resort" to get started</p>
          </div>
        `;
      } else {
        container.innerHTML = resorts.map(resort => `
          <div class="resort-card">
            <div class="resort-header">
              <img src="${resort.image}" alt="${resort.name}" class="resort-image">
              <div class="resort-info">
                <h3 class="resort-name">${resort.name}</h3>
                <p class="resort-address">${resort.address}</p>
                <div class="resort-badges">
                  <span class="badge badge-${resort.price}">${resort.price.toUpperCase()}</span>
                  <span class="badge" style="background: #f3f4f6; color: #374151;">${resort.bedrooms} Bedrooms</span>
                  <span class="badge" style="background: #fef3c7; color: #92400e;">${resort.priceValue}</span>
                </div>
              </div>
              <div class="resort-actions">
                <button class="btn btn-primary" onclick="editResort('${resort.key}')">
                  <i data-lucide="edit" style="width: 16px; height: 16px;"></i>
                  Edit
                </button>
                <button class="btn btn-danger" onclick="deleteResort('${resort.key}', '${resort.name}')">
                  <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
                  Delete
                </button>
              </div>
            </div>
            <div class="resort-body">
              <p class="resort-description">${resort.description}</p>
              <div class="resort-details">
                <div class="detail-item">
                  <i data-lucide="check-circle" style="width: 16px; height: 16px;"></i>
                  <span>${resort.facilities?.length || 0} Facilities</span>
                </div>
                <div class="detail-item">
                  <i data-lucide="star" style="width: 16px; height: 16px;"></i>
                  <span>${resort.amenities?.length || 0} Amenities</span>
                </div>
                ${resort.latitude && resort.longitude ? `
                <div class="detail-item">
                  <i data-lucide="map-pin" style="width: 16px; height: 16px;"></i>
                  <span>${resort.latitude}, ${resort.longitude}</span>
                </div>
                ` : ''}
              </div>
            </div>
          </div>
        `).join('');
      }
      
      lucide.createIcons();
    }

    // Render Feedback
    function renderFeedback() {
      const container = document.getElementById('feedback-container');
      const activeFeedbacks = feedbacks.filter(f => !f.archived);
      
      if (activeFeedbacks.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i data-lucide="message-square" class="empty-icon"></i>
            <h3 class="empty-title">No feedback yet</h3>
            <p class="empty-text">Customer feedback will appear here</p>
          </div>
        `;
      } else {
        const resortGroups = {};
        activeFeedbacks.forEach(feedback => {
          const resortKey = feedback.resortName || 'Unknown Resort';
          if (!resortGroups[resortKey]) {
            resortGroups[resortKey] = [];
          }
          resortGroups[resortKey].push(feedback);
        });

        container.innerHTML = Object.entries(resortGroups).map(([resortName, feedbackList]) => {
          const avgRating = feedbackList.reduce((sum, f) => sum + (f.rating || 0), 0) / feedbackList.length;
          
          return `
            <div class="resort-card">
              <div class="resort-header" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
                <div class="resort-info">
                  <h3 class="resort-name" style="color: white;">${resortName}</h3>
                  <p style="color: rgba(255,255,255,0.9);">${feedbackList.length} reviews | ${avgRating.toFixed(1)} average rating</p>
                </div>
              </div>
              <div class="resort-body">
                ${feedbackList.map(feedback => {
                  const name = feedback.name || feedback.userName || 'Anonymous';
                  const message = feedback.message || feedback.feedback || 'No message';
                  const rating = feedback.rating || 0;
                  
                  let date = new Date();
                  if (feedback.timestamp?.toDate) {
                    date = feedback.timestamp.toDate();
                  } else if (feedback.timestamp instanceof Date) {
                    date = feedback.timestamp;
                  }
                  
                  return `
                    <div style="padding: 16px; border-bottom: 1px solid #f1f5f9; last-child:border-bottom: none;">
                      <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <strong style="color: #111827;">${name}</strong>
                        <span style="color: #64748b; font-size: 13px;">${date.toLocaleDateString()}</span>
                      </div>
                      <div style="display: flex; gap: 4px; margin-bottom: 8px;">
                        ${[1,2,3,4,5].map(star => `
                          <i data-lucide="star" style="width: 14px; height: 14px; ${star <= rating ? 'fill: #fbbf24; color: #fbbf24;' : 'color: #d1d5db;'}"></i>
                        `).join('')}
                        <span style="margin-left: 8px; font-weight: 600; color: #374151;">${rating}.0</span>
                      </div>
                      <p style="color: #4b5563; line-height: 1.6;">${message}</p>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `;
        }).join('');
      }
      
      lucide.createIcons();
    }

    // Update Stats
    function updateStats() {
      document.getElementById('total-resorts').textContent = resorts.length;
      document.getElementById('total-feedback').textContent = feedbacks.filter(f => !f.archived).length;
      
      const activeFeedbacks = feedbacks.filter(f => !f.archived);
      const totalRating = activeFeedbacks.reduce((sum, f) => sum + (f.rating || 0), 0);
      const avgRating = activeFeedbacks.length > 0 ? (totalRating / activeFeedbacks.length).toFixed(1) : '0.0';
      document.getElementById('avg-rating').textContent = avgRating;
      
      document.getElementById('archived-count').textContent = feedbacks.filter(f => f.archived).length;
    }

    // Open Modal for Adding Resort
    document.getElementById('add-resort-btn').addEventListener('click', () => {
      currentEditingResortKey = null;
      document.getElementById('resort-modal-title').textContent = 'Add New Resort';
      document.getElementById('resort-form').reset();
      document.getElementById('resort-modal').classList.add('active');
      lucide.createIcons();
    });

    // Edit Resort
    window.editResort = function(key) {
      const resort = resorts.find(r => r.key === key);
      if (!resort) return;

      currentEditingResortKey = key;
      document.getElementById('resort-modal-title').textContent = 'Edit Resort';
      
      document.getElementById('resort-name').value = resort.name || '';
      document.getElementById('resort-address').value = resort.address || '';
      document.getElementById('resort-description').value = resort.description || '';
      document.getElementById('resort-image').value = resort.image || '';
      document.getElementById('resort-bedrooms').value = resort.bedrooms || '';
      document.getElementById('resort-price').value = resort.price || '';
      document.getElementById('resort-price-value').value = resort.priceValue || '';
      document.getElementById('resort-price-numeric').value = resort.priceNumeric || '';
      document.getElementById('resort-latitude').value = resort.latitude || '';
      document.getElementById('resort-longitude').value = resort.longitude || '';
      document.getElementById('resort-facilities').value = resort.facilities?.join(', ') || '';
      
      // Set amenities
      document.querySelectorAll('input[name="amenity"]').forEach(checkbox => {
        checkbox.checked = resort.amenities?.includes(checkbox.value) || false;
      });
      
      document.getElementById('resort-modal').classList.add('active');
      lucide.createIcons();
    };

    // Delete Resort
    window.deleteResort = async function(key, name) {
      if (!confirm(`Are you sure you want to delete "${name}"? This action cannot be undone.`)) {
        return;
      }

      try {
        await remove(ref(db, `resorts/${key}`));
        alert('Resort deleted successfully!');
      } catch (error) {
        console.error('Error deleting resort:', error);
        alert('Failed to delete resort: ' + error.message);
      }
    };

    // Close Modal
    document.getElementById('resort-modal-close').addEventListener('click', () => {
      document.getElementById('resort-modal').classList.remove('active');
    });

    document.getElementById('resort-cancel-btn').addEventListener('click', () => {
      document.getElementById('resort-modal').classList.remove('active');
    });

    document.getElementById('resort-modal').addEventListener('click', (e) => {
      if (e.target.id === 'resort-modal') {
        document.getElementById('resort-modal').classList.remove('active');
      }
    });

    // Save Resort
    document.getElementById('resort-save-btn').addEventListener('click', async () => {
      const form = document.getElementById('resort-form');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const amenities = Array.from(document.querySelectorAll('input[name="amenity"]:checked'))
        .map(cb => cb.value);

      const facilitiesText = document.getElementById('resort-facilities').value;
      const facilities = facilitiesText ? facilitiesText.split(',').map(f => f.trim()).filter(f => f) : [];

      const resortData = {
        id: currentEditingResortKey ? resorts.find(r => r.key === currentEditingResortKey)?.id : Date.now(),
        name: document.getElementById('resort-name').value.trim(),
        address: document.getElementById('resort-address').value.trim(),
        description: document.getElementById('resort-description').value.trim(),
        image: document.getElementById('resort-image').value.trim(),
        bedrooms: parseInt(document.getElementById('resort-bedrooms').value),
        price: document.getElementById('resort-price').value,
        priceValue: document.getElementById('resort-price-value').value.trim(),
        priceNumeric: parseInt(document.getElementById('resort-price-numeric').value),
        latitude: document.getElementById('resort-latitude').value ? parseFloat(document.getElementById('resort-latitude').value) : null,
        longitude: document.getElementById('resort-longitude').value ? parseFloat(document.getElementById('resort-longitude').value) : null,
        facilities: facilities,
        amenities: amenities
      };

      try {
        if (currentEditingResortKey) {
          await update(ref(db, `resorts/${currentEditingResortKey}`), resortData);
          alert('Resort updated successfully!');
        } else {
          const newResortRef = push(ref(db, 'resorts'));
          await set(newResortRef, resortData);
          alert('Resort added successfully!');
        }
        
        document.getElementById('resort-modal').classList.remove('active');
        form.reset();
      } catch (error) {
        console.error('Error saving resort:', error);
        alert('Failed to save resort: ' + error.message);
      }
    });

    // Tab Switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.getAttribute('data-tab');
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');
        
        lucide.createIcons();
      });
    });

    // Authentication Setup
    async function setupAuth() {
      try {
        await setPersistence(auth, browserLocalPersistence);
      } catch (error) {
        console.error("Persistence error:", error);
      }

      onAuthStateChanged(auth, (user) => {
        document.getElementById('loading').classList.add('hidden');

        if (user) {
          console.log('User authenticated:', user.email);
          document.getElementById('login-container').classList.add('hidden');
          document.getElementById('main-content').style.display = 'block';
          document.getElementById('user-id-display').textContent = `Admin User ID: ${user.uid}`;
          
          loadResorts();
          loadFeedback();
          lucide.createIcons();
        } else {
          console.log('User not authenticated');
          document.getElementById('main-content').style.display = 'none';
          document.getElementById('login-container').style.display = 'flex';
        }
      });
    }

    // Login Form Handler
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      const errorElement = document.getElementById('login-error');
      const loginBtn = document.getElementById('login-btn');

      errorElement.textContent = '';

      if (!email || !password) {
        errorElement.textContent = "Please enter both email and password.";
        return;
      }

      loginBtn.disabled = true;
      loginBtn.textContent = 'Signing in...';

      try {
        await signInWithEmailAndPassword(auth, email, password);
        console.log('Login successful');
      } catch (error) {
        console.error("Login error:", error);
        let message = "Login failed. Please check your credentials.";

        if (error.code === 'auth/user-not-found') {
          message = "No user found with this email.";
        } else if (error.code === 'auth/wrong-password') {
          message = "Incorrect password.";
        } else if (error.code === 'auth/invalid-email') {
          message = "Invalid email address.";
        } else if (error.code === 'auth/too-many-requests') {
          message = "Too many failed attempts. Please try again later.";
        } else if (error.code === 'auth/invalid-credential') {
          message = "Invalid credentials. Please check your email and password.";
        }

        errorElement.textContent = message;
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Sign In';
      }
    });

    // Sign Out Handler
    document.getElementById('signout-btn').addEventListener('click', async () => {
      try {
        await signOut(auth);
        console.log("User signed out");
        window.location.href = 'index.html';
      } catch (error) {
        console.error("Sign out error:", error);
        alert('Failed to sign out. Please try again.');
      }
    });

    // Initialize icons on page load
    lucide.createIcons();

    // Start authentication
    setupAuth();
  </script>
</body>

</html>
